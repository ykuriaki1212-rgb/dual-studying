# 🔧 認証エラー完全解決ガイド

## ⚠️ 発生したエラー

```
Exception: You do not have permission to call SpreadsheetApp.getActiveSpreadsheet
```

このエラーは、Apps Scriptが適切に認証されていないか、スコープ（権限）の設定に問題がある場合に発生します。

## ✅ 解決方法（3つの方法）

以下の方法を**順番に**試してください。

---

## 【方法1】完全に最初からやり直す（最も確実）

### Step 1: 新しいスプレッドシートを作成

1. Google Driveを開く: https://drive.google.com
2. 「新規」→「Googleスプレッドシート」→「空白のスプレッドシート」
3. 名前を「**ダブル受験進捗記録簿**」に変更

### Step 2: Apps Scriptを開く

1. スプレッドシートで「**拡張機能**」→「**Apps Script**」をクリック
2. 新しいタブでApps Scriptエディタが開きます
3. **重要**: このとき、URLに `spreadsheets.google.com` が含まれていることを確認
   - ✅ 正しい: `https://script.google.com/home/projects/ABC.../edit`（スプレッドシートから開いた場合）
   - ❌ 間違い: `https://script.google.com/home`（スタンドアロンプロジェクト）

### Step 3: コードを貼り付け

1. 既存のコード（`function myFunction() {`...）を**全て削除**
2. `code.gs` の内容を**全てコピー**して貼り付け
3. `Ctrl + S`（Mac: `Cmd + S`）で保存

### Step 4: マニフェストファイルを設定（重要！）

1. 左メニューの「**プロジェクトの設定**」（⚙歯車アイコン）をクリック
2. 下にスクロールして「**appsscript.json マニフェスト ファイルをエディタで表示する**」に✓チェック
3. 左メニューに戻ると「**appsscript.json**」が表示される
4. `appsscript.json` をクリック
5. 既存の内容を全て削除
6. 以下の内容を貼り付け:

```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/script.external_request"
  ]
}
```

7. 保存（`Ctrl + S`）

### Step 5: 実行して認証

1. 左メニューで「**コード.gs**」に戻る
2. 関数セレクタで「**testInit**」を選択
3. 「**▶実行**」をクリック
4. 「**承認が必要です**」ダイアログが表示される
   - 「**権限を確認**」をクリック
5. アカウントを選択
6. 「**このアプリは確認されていません**」と表示される場合:
   - 左下の「**詳細**」をクリック
   - 「**（プロジェクト名）に移動**」をクリック
   - すべての権限を確認
   - 「**許可**」をクリック

### Step 6: 実行ログを確認

実行ログに以下が表示されればOK:

```
========================================
✅ 初期化が完了しました！
========================================
```

---

## 【方法2】既存のプロジェクトで権限をリセット

### Step 1: 認証をリセット

1. Apps Scriptエディタを開く
2. 左メニューの「**プロジェクトの設定**」（⚙）をクリック
3. 下にスクロール
4. 「**OAuth 同意画面**」セクションを確認
5. もし以前の承認がある場合は、Google アカウントのセキュリティ設定から削除:
   - https://myaccount.google.com/permissions にアクセス
   - プロジェクト名を探して「**アクセス権を削除**」

### Step 2: マニフェストファイルを追加

方法1のStep 4と同じ手順でマニフェストファイルを設定

### Step 3: 再実行

`testInit` を再実行して認証を許可

---

## 【方法3】スタンドアロンプロジェクトとして実行

この方法は、スプレッドシートから開いても権限エラーが解決しない場合の最終手段です。

### Step 1: スプレッドシートIDを確認

1. スプレッドシートを開く
2. URLから以下の部分をコピー:
   ```
   https://docs.google.com/spreadsheets/d/【この部分がID】/edit
   ```
   例: `1ABcD2EfGhI3JkLmN4oPqR5sTuVwX6yZ`

### Step 2: コードを修正

`code.gs` の6行目あたりの `getSpreadsheet()` 関数を以下に置き換え:

```javascript
function getSpreadsheet() {
  // ここにスプレッドシートIDを貼り付け
  const SPREADSHEET_ID = '1ABcD2EfGhI3JkLmN4oPqR5sTuVwX6yZ';
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}
```

### Step 3: マニフェストファイルのスコープを追加

`appsscript.json` のスコープに追加:

```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/spreadsheets.currentonly",
    "https://www.googleapis.com/auth/script.external_request"
  ]
}
```

### Step 4: 再実行

---

## 🔍 エラーが続く場合のチェックリスト

以下を確認してください:

- [ ] スプレッドシートから「拡張機能」→「Apps Script」で開いた
- [ ] Apps ScriptのURLに `spreadsheets` が含まれている
- [ ] マニフェストファイル（appsscript.json）を設定した
- [ ] `oauthScopes` に `spreadsheets` が含まれている
- [ ] 認証ダイアログで「許可」をクリックした
- [ ] 「このアプリは確認されていません」の場合、「詳細」→「移動」をクリックした
- [ ] ブラウザのポップアップブロックを無効にした
- [ ] シークレットモードではなく通常モードで開いた

---

## 📸 スクリーンショット付き手順

### 認証画面の例

**1. 最初の承認画面**
```
承認が必要です
このプロジェクトにアクセスするには、
あなたの許可が必要です。
[キャンセル] [権限を確認]
```
→ 「**権限を確認**」をクリック

**2. アカウント選択**
```
アカウントを選択
```
→ 使用するGoogleアカウントを選択

**3. このアプリは確認されていません（表示される場合）**
```
このアプリは確認されていません
このアプリはGoogleで確認されていません
[戻る] [詳細]
```
→ 左下の「**詳細**」をクリック

**4. 詳細画面**
```
このアプリは確認されていません
（プロジェクト名）に移動（安全ではないページ）
```
→ 「**（プロジェクト名）に移動**」をクリック

**5. 権限の確認**
```
（プロジェクト名）が次の許可をリクエストしています
✓ Google スプレッドシートのすべてのスプレッドシートの表示、編集、作成、削除
[キャンセル] [許可]
```
→ 「**許可**」をクリック

---

## ✅ 成功の確認

実行ログに以下が表示されれば成功です:

```
=== 初期化開始 ===

✓ スプレッドシート取得成功
  名前: ダブル受験進捗記録簿
  ID: 1ABcD2EfG...

[1/4] 進捗データシート作成中...
  新しいシートを作成しました
  ✓ 進捗データシート作成完了（37列）

[2/4] 更新ログシート作成中...
  ✓ 更新ログシート作成完了

[3/4] 初期ログ記録中...
  ✓ 初期ログ記録完了

[4/4] 書式設定中...
  ✓ 書式設定完了

========================================
✅ 初期化が完了しました！
========================================
```

スプレッドシートに戻ると、以下の2つのシートが作成されています:
- **進捗データ** (青いヘッダー)
- **更新ログ** (緑のヘッダー)

---

## 🎯 次のステップ

初期化が成功したら:

1. **デプロイ**
   - 「デプロイ」→「新しいデプロイ」
   - 種類: ウェブアプリ
   - アクセス権限: **全員**
   - URLをコピー

2. **HTMLファイルの設定**
   - `dashboard.html` の `API_URL` に貼り付け

3. **動作確認**
   - ブラウザで開いて「🟢 同期済み」を確認

---

どの方法を試しても解決しない場合は、エラーメッセージのスクリーンショットを確認させてください！
